<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blackjack Pro Bot - Mesa Completa</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:-apple-system,sans-serif; background:linear-gradient(135deg,#0a0e27,#1a1f3a,#2d1b4e); color:#fff; min-height:100vh; padding:16px; }
    .container { max-width:1400px; margin:0 auto; }
    h1 { font-size:28px; text-align:center; margin-bottom:8px; background:linear-gradient(135deg,#fbbf24,#f59e0b); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .subtitle { text-align:center; font-size:11px; opacity:0.7; margin-bottom:20px; }
    .box { background:rgba(255,255,255,0.08); backdrop-filter:blur(10px); border-radius:12px; padding:20px; margin-bottom:16px; border:1px solid rgba(255,255,255,0.1); }
    
    /* STATS */
    .stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(110px,1fr)); gap:10px; margin-bottom:16px; }
    .stat { background:rgba(255,255,255,0.1); padding:12px; border-radius:8px; text-align:center; }
    .stat-label { font-size:9px; opacity:0.7; text-transform:uppercase; margin-bottom:4px; }
    .stat-value { font-size:20px; font-weight:900; }
    .positive { color:#4ade80; }
    .negative { color:#ef4444; }
    .neutral { color:#60a5fa; }
    .warning { color:#fbbf24; animation:pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity:1; } 50% { opacity:0.6; } }
    
    /* MESA DE JUEGO */
    .table-container { background:linear-gradient(135deg,#0d5f1f,#1a472a); border-radius:20px; padding:30px; margin-bottom:20px; border:3px solid #2d7a3f; box-shadow:0 10px 40px rgba(0,0,0,0.5); }
    
    .dealer-area { text-align:center; margin-bottom:40px; }
    .dealer-title { font-size:16px; font-weight:700; margin-bottom:12px; color:#fbbf24; }
    .dealer-cards { display:flex; gap:8px; justify-content:center; margin-bottom:10px; min-height:80px; }
    
    .players-area { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:16px; margin-bottom:30px; }
    .player-box { background:rgba(0,0,0,0.3); border-radius:12px; padding:16px; border:2px solid rgba(255,255,255,0.2); transition:all 0.3s; }
    .player-box.active { border-color:#4ade80; box-shadow:0 0 20px rgba(74,222,128,0.3); }
    .player-box.you { border-color:#fbbf24; background:rgba(251,191,36,0.15); }
    .player-title { font-size:14px; font-weight:700; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; }
    .player-cards { display:flex; gap:6px; flex-wrap:wrap; min-height:70px; margin-bottom:8px; }
    .player-total { font-size:16px; font-weight:700; opacity:0.8; }
    
    .card { width:45px; height:65px; background:#fff; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:20px; font-weight:900; color:#000; box-shadow:0 2px 8px rgba(0,0,0,0.3); }
    .card.hidden { background:linear-gradient(135deg,#dc2626,#991b1b); color:#fff; font-size:14px; }
    
    /* CONTROLES DE REGISTRO */
    .register-controls { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:20px; }
    .register-btn { padding:20px; font-size:15px; font-weight:800; border:none; border-radius:12px; cursor:pointer; transition:all 0.2s; }
    .register-btn:hover { transform:translateY(-2px); }
    .register-btn.my-card { background:linear-gradient(135deg,#fbbf24,#f59e0b); color:#000; }
    .register-btn.table-card { background:linear-gradient(135deg,#60a5fa,#3b82f6); color:#fff; }
    .register-btn.dealer-card { background:linear-gradient(135deg,#ef4444,#dc2626); color:#fff; }
    
    /* SELECTOR DE CARTAS */
    .card-selector { display:grid; grid-template-columns:repeat(13,1fr); gap:5px; margin-bottom:16px; }
    .card-btn { aspect-ratio:1; font-size:15px; font-weight:900; border:none; border-radius:6px; cursor:pointer; color:#fff; transition:all 0.15s; }
    .card-btn:hover { transform:scale(1.1); box-shadow:0 4px 12px rgba(0,0,0,0.4); }
    .card-btn:active { transform:scale(0.95); }
    .card-btn.low { background:linear-gradient(135deg,#4ade80,#22c55e); }
    .card-btn.mid { background:linear-gradient(135deg,#60a5fa,#3b82f6); }
    .card-btn.high { background:linear-gradient(135deg,#ef4444,#dc2626); }
    
    /* AI PANEL */
    .ai-panel { background:linear-gradient(135deg,rgba(74,222,128,0.12),rgba(34,197,94,0.08)); border:2px solid rgba(74,222,128,0.3); border-radius:12px; padding:20px; margin-bottom:16px; position:relative; }
    .ai-panel::before { content:'ü§ñ'; position:absolute; top:16px; right:20px; font-size:28px; opacity:0.4; }
    .ai-action { font-size:26px; font-weight:900; margin-bottom:10px; }
    .ai-reason { font-size:12px; opacity:0.8; line-height:1.4; margin-bottom:8px; }
    .ai-stats { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:12px; }
    .ai-stat { background:rgba(0,0,0,0.3); padding:8px; border-radius:6px; text-align:center; font-size:11px; }
    
    /* HUMANIZER */
    .humanizer { background:rgba(251,191,36,0.12); border:2px solid rgba(251,191,36,0.4); border-radius:10px; padding:14px; margin-bottom:16px; display:none; }
    .humanizer.active { display:block; animation:slideIn 0.4s; }
    @keyframes slideIn { from { opacity:0; transform:translateY(-8px); } to { opacity:1; transform:translateY(0); } }
    
    /* BUTTONS */
    .btn-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px; margin-bottom:16px; }
    .btn { padding:14px; font-size:13px; font-weight:800; border:none; border-radius:10px; cursor:pointer; text-transform:uppercase; transition:all 0.2s; }
    .btn:hover { transform:translateY(-2px); }
    .btn-primary { background:linear-gradient(135deg,#4ade80,#22c55e); color:#000; }
    .btn-secondary { background:linear-gradient(135deg,#60a5fa,#3b82f6); color:#fff; }
    .btn-danger { background:linear-gradient(135deg,#ef4444,#dc2626); color:#fff; }
    .btn-warning { background:linear-gradient(135deg,#fbbf24,#f59e0b); color:#000; }
    .btn:disabled { opacity:0.5; cursor:not-allowed; }
    
    /* LOG */
    .log { background:rgba(0,0,0,0.5); border-radius:10px; padding:14px; max-height:250px; overflow-y:auto; font-size:10px; line-height:1.6; font-family:monospace; }
    .log-entry { padding:4px 0; border-bottom:1px solid rgba(255,255,255,0.1); }
    .log-success { color:#4ade80; }
    .log-error { color:#ef4444; }
    .log-warning { color:#fbbf24; }
    
    /* CONFIG */
    .config-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; }
    .form-group { margin-bottom:12px; }
    .form-label { font-size:11px; font-weight:700; margin-bottom:6px; display:block; }
    .form-input, .form-select { width:100%; padding:8px; border-radius:6px; border:2px solid rgba(255,255,255,0.2); background:rgba(0,0,0,0.3); color:#fff; font-size:13px; }
    .checkbox { display:flex; align-items:center; gap:8px; padding:8px; background:rgba(0,0,0,0.3); border-radius:6px; cursor:pointer; }
    .checkbox input { width:18px; height:18px; cursor:pointer; }
    
    details { margin-bottom:14px; }
    summary { cursor:pointer; padding:10px; background:rgba(255,255,255,0.1); border-radius:8px; font-weight:700; font-size:13px; }
    details[open] summary { margin-bottom:12px; }
    
    .hidden { display:none !important; }
    .phase-indicator { text-align:center; font-size:14px; font-weight:700; color:#4ade80; margin-bottom:16px; padding:10px; background:rgba(74,222,128,0.1); border-radius:8px; }
  </style>
</head>
<body>
<div class="container">
  <h1>üé∞ BLACKJACK PRO BOT</h1>
  <div class="subtitle">MESA COMPLETA ‚Ä¢ HI-LO ‚Ä¢ ILLUSTRIOUS 18 ‚Ä¢ TRACKING MULTI-JUGADOR</div>

  <!-- STATS -->
  <div class="stats">
    <div class="stat">
      <div class="stat-label">RC</div>
      <div class="stat-value neutral" id="rc">0</div>
    </div>
    <div class="stat">
      <div class="stat-label">TC</div>
      <div class="stat-value neutral" id="tc">0</div>
    </div>
    <div class="stat">
      <div class="stat-label">Apuesta</div>
      <div class="stat-value neutral" id="bet">$10</div>
    </div>
    <div class="stat">
      <div class="stat-label">Bankroll</div>
      <div class="stat-value neutral" id="bankroll">$1000</div>
    </div>
    <div class="stat">
      <div class="stat-label">Edge</div>
      <div class="stat-value neutral" id="edge">0.0%</div>
    </div>
    <div class="stat">
      <div class="stat-label">Penetr.</div>
      <div class="stat-value neutral" id="penetration">0%</div>
    </div>
    <div class="stat">
      <div class="stat-label">Manos</div>
      <div class="stat-value neutral" id="hands">0</div>
    </div>
  </div>

  <!-- HUMANIZER ALERT -->
  <div class="humanizer" id="humanizerAlert">
    <div id="humanizerText"></div>
  </div>

  <!-- PHASE INDICATOR -->
  <div class="phase-indicator" id="phaseIndicator">Esperando inicio de mano...</div>

  <!-- MESA DE JUEGO -->
  <div class="table-container">
    <!-- DEALER -->
    <div class="dealer-area">
      <div class="dealer-title">üé¥ DEALER</div>
      <div class="dealer-cards" id="dealerCards"></div>
      <div id="dealerTotal" style="font-size:16px; font-weight:700; opacity:0.8;"></div>
    </div>

    <!-- JUGADORES -->
    <div class="players-area" id="playersArea"></div>
  </div>

  <!-- CONTROLES DE REGISTRO -->
  <div class="box">
    <h3 style="margin-bottom:14px; font-size:15px;">üìù Registrar Cartas</h3>
    
    <div class="register-controls">
      <button class="register-btn my-card" onclick="setRegisterMode('myCard')">
        <div style="font-size:24px; margin-bottom:6px;">üë§</div>
        <div>MI CARTA</div>
        <div style="font-size:10px; opacity:0.7; margin-top:4px;">Para mi mano</div>
      </button>
      <button class="register-btn table-card" onclick="setRegisterMode('tableCard')">
        <div style="font-size:24px; margin-bottom:6px;">üë•</div>
        <div>CARTA MESA</div>
        <div style="font-size:10px; opacity:0.7; margin-top:4px;">Otros jugadores</div>
      </button>
      <button class="register-btn dealer-card" onclick="setRegisterMode('dealerCard')">
        <div style="font-size:24px; margin-bottom:6px;">üé¥</div>
        <div>CARTA DEALER</div>
        <div style="font-size:10px; opacity:0.7; margin-top:4px;">Dealer visible</div>
      </button>
    </div>

    <div style="margin-bottom:10px; text-align:center; font-size:13px; font-weight:700; color:#4ade80;" id="registerModeText">
      Selecciona un modo arriba
    </div>

    <div class="card-selector" id="cardSelector"></div>
  </div>

  <!-- AI PANEL -->
  <div class="ai-panel">
    <div class="ai-action" id="aiAction">‚è≥ Esperando tu mano...</div>
    <div class="ai-reason" id="aiReason">Registra tus cartas y la carta visible del dealer para obtener recomendaci√≥n</div>
    <div class="ai-stats">
      <div class="ai-stat">
        <div style="opacity:0.7;">Decisi√≥n</div>
        <div style="font-weight:700; margin-top:4px;" id="aiDecision">-</div>
      </div>
      <div class="ai-stat">
        <div style="opacity:0.7;">√çndice TC</div>
        <div style="font-weight:700; margin-top:4px;" id="aiIndex">-</div>
      </div>
      <div class="ai-stat">
        <div style="opacity:0.7;">Confianza</div>
        <div style="font-weight:700; margin-top:4px;" id="aiConfidence">100%</div>
      </div>
    </div>
  </div>

  <!-- CONTROLS -->
  <div class="btn-row">
    <button class="btn btn-primary" onclick="newHand()">üÜï NUEVA MANO</button>
    <button class="btn btn-secondary" onclick="calculateDecision()">üß† CALCULAR</button>
    <button class="btn btn-warning" onclick="shuffle()">üîÑ SHUFFLE</button>
    <button class="btn btn-danger" onclick="resetAll()">‚Üª RESET</button>
  </div>

  <!-- ESTAD√çSTICAS -->
  <details open>
    <summary>üìä ESTAD√çSTICAS DE SESI√ìN</summary>
    <div class="box">
      <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(130px,1fr)); gap:12px; text-align:center;">
        <div>
          <div style="font-size:10px; opacity:0.7;">Manos Jugadas</div>
          <div style="font-size:24px; font-weight:900;" id="statHands">0</div>
        </div>
        <div>
          <div style="font-size:10px; opacity:0.7;">W / L / P</div>
          <div style="font-size:20px; font-weight:900;"><span id="statWins">0</span>/<span id="statLosses">0</span>/<span id="statPush">0</span></div>
        </div>
        <div>
          <div style="font-size:10px; opacity:0.7;">Win Rate</div>
          <div style="font-size:24px; font-weight:900;" id="statWinRate">0%</div>
        </div>
        <div>
          <div style="font-size:10px; opacity:0.7;">Profit</div>
          <div style="font-size:24px; font-weight:900;" id="statProfit">$0</div>
        </div>
        <div>
          <div style="font-size:10px; opacity:0.7;">Errores Camuflaje</div>
          <div style="font-size:24px; font-weight:900;" id="statErrors">0</div>
        </div>
      </div>
    </div>
  </details>

  <!-- CONFIGURACI√ìN -->
  <details>
    <summary>‚öôÔ∏è CONFIGURACI√ìN DE MESA</summary>
    <div class="box config-grid">
      <div class="form-group">
        <label class="form-label">Jugadores en la Mesa</label>
        <select class="form-select" id="numPlayers" onchange="updateConfig()">
          <option value="1">1 (Solo t√∫)</option>
          <option value="2">2 jugadores</option>
          <option value="3" selected>3 jugadores</option>
          <option value="4">4 jugadores</option>
          <option value="5">5 jugadores</option>
          <option value="6">6 jugadores</option>
          <option value="7">7 jugadores (lleno)</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Tu Posici√≥n</label>
        <select class="form-select" id="yourPosition" onchange="updateConfig()">
          <option value="1" selected>Posici√≥n 1 (Primera base)</option>
          <option value="2">Posici√≥n 2</option>
          <option value="3">Posici√≥n 3 (Tercera base)</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">N√∫mero de Mazos</label>
        <select class="form-select" id="numDecks" onchange="updateConfig()">
          <option value="1">1 mazo</option>
          <option value="2">2 mazos</option>
          <option value="6" selected>6 mazos</option>
          <option value="8">8 mazos</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Penetraci√≥n (%)</label>
        <input type="number" class="form-input" id="penetrationPct" value="75" min="50" max="95" onchange="updateConfig()">
      </div>
      <div class="form-group">
        <label class="form-label">Bankroll ($)</label>
        <input type="number" class="form-input" id="initialBank" value="1000" min="100" onchange="updateConfig()">
      </div>
      <div class="form-group">
        <label class="form-label">Apuesta M√≠n ($)</label>
        <input type="number" class="form-input" id="minBet" value="10" min="1" onchange="updateConfig()">
      </div>
      <div class="form-group">
        <label class="form-label">Spread M√°x</label>
        <input type="number" class="form-input" id="maxSpread" value="12" min="2" max="20" onchange="updateConfig()">
      </div>
      <div class="form-group">
        <label class="form-label">Tasa Errores (%)</label>
        <input type="number" class="form-input" id="errorRate" value="2" min="0" max="10" onchange="updateConfig()">
      </div>
      <label class="checkbox">
        <input type="checkbox" id="surrender" checked onchange="updateConfig()">
        <span>Late Surrender</span>
      </label>
      <label class="checkbox">
        <input type="checkbox" id="enableHumanizer" checked onchange="updateConfig()">
        <span>Humanizer (Camuflaje)</span>
      </label>
    </div>
  </details>

  <!-- LOG -->
  <details>
    <summary>üìã REGISTRO DETALLADO</summary>
    <div class="log" id="log"></div>
  </details>
</div>

<script>
const CONFIG = {
  numPlayers: 3,
  yourPosition: 1,
  decks: 6,
  penetration: 0.75,
  surrender: true,
  bankroll: 1000,
  minBet: 10,
  maxSpread: 12,
  errorRate: 2,
  enableHumanizer: true
};

const HI_LO = {
  '2':1, '3':1, '4':1, '5':1, '6':1,
  '7':0, '8':0, '9':0,
  '10':-1, 'J':-1, 'Q':-1, 'K':-1, 'A':-1
};

const CARD_VALUES = {
  '2':2, '3':3, '4':4, '5':5, '6':6, '7':7, '8':8, '9':9,
  '10':10, 'J':10, 'Q':10, 'K':10, 'A':11
};

const ALL_CARDS = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];

const ILLUSTRIOUS_18 = {
  insurance: 3,
  '16v10': 0,
  '15v10': 4,
  '13v2': -1,
  '13v3': -2,
  '12v2': 3,
  '12v3': 2,
  '12v4': 0,
  '11vA': 1,
  '10v10': 4,
  '10vA': 4,
  '9v2': 1,
  '9v7': 3,
  '20v5': 5,
  '20v6': 4
};

let state = {
  runningCount: 0,
  cardsPlayed: 0,
  currentBankroll: 1000,
  handsPlayed: 0,
  handsWon: 0,
  handsLost: 0,
  handsPush: 0,
  humanErrors: 0,
  registerMode: null,
  currentPhase: 'waiting',
  players: [],
  dealer: { cards: [], visibleCard: null },
  myCards: [],
  gameLog: []
};

class Shoe {
  constructor(numDecks) {
    this.numDecks = numDecks;
    this.totalCards = numDecks * 52;
    this.reset();
  }
  reset() {
    this.cards = [];
    for(let d = 0; d < this.numDecks; d++) {
      for(let s = 0; s < 4; s++) {
        ALL_CARDS.forEach(c => this.cards.push(c));
      }
    }
    this.shuffle();
  }
  shuffle() {
    for(let i = this.cards.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [this.cards[i], this.cards[j]] = [this.cards[j], this.cards[i]];
    }
  }
  needsShuffle(penetration) {
    return (this.cards.length / this.totalCards) < (1 - penetration);
  }
  getDecksRemaining() {
    return Math.max(0.5, this.cards.length / 52);
  }
}

let shoe = new Shoe(CONFIG.decks);

class Counter {
  static updateCount(card) {
    state.runningCount += HI_LO[card];
    state.cardsPlayed++;
  }
  static trueCount() {
    return Math.trunc(state.runningCount / shoe.getDecksRemaining());
  }
  static calculateEdge(tc) {
    return tc * 0.005;
  }
}

class BetManager {
  static getSuggestedBet(tc) {
    if(tc <= 0) return CONFIG.minBet;
    let units = 1;
    if(tc >= 5) units = CONFIG.maxSpread;
    else if(tc >= 4) units = Math.min(10, CONFIG.maxSpread);
    else if(tc >= 3) units = Math.min(6, CONFIG.maxSpread);
    else if(tc >= 2) units = Math.min(4, CONFIG.maxSpread);
    else if(tc >= 1) units = 2;
    return Math.min(CONFIG.minBet * units, state.currentBankroll * 0.05);
  }
}

class Strategy {
  static getOptimalPlay(playerHand, dealerCard, tc) {
    const myTotal = this.handValue(playerHand);
    const dealerValue = CARD_VALUES[dealerCard];
    const soft = this.isSoft(playerHand);
    const pair = this.isPair(playerHand);
    
    if(playerHand.length === 2 && myTotal === 21) {
      return { action: 'BLACKJACK', emoji: 'üéâ', reason: 'Blackjack natural (paga 3:2)', index: null };
    }
    if(myTotal > 21) {
      return { action: 'BUST', emoji: 'üí•', reason: 'Pasado de 21', index: null };
    }
    if(dealerCard === 'A' && tc >= ILLUSTRIOUS_18.insurance) {
      return { action: 'INSURANCE', emoji: 'üõ°Ô∏è', reason: `TC‚â•+${ILLUSTRIOUS_18.insurance}: tomar seguro`, index: ILLUSTRIOUS_18.insurance };
    }
    if(CONFIG.surrender && playerHand.length === 2) {
      if(myTotal === 16 && dealerValue === 10) {
        if(tc >= ILLUSTRIOUS_18['16v10']) {
          return { action: 'STAND', emoji: '‚úã', reason: `16v10 TC‚â•${ILLUSTRIOUS_18['16v10']}: plantarse (Ill-18)`, index: ILLUSTRIOUS_18['16v10'] };
        }
        return { action: 'SURRENDER', emoji: 'üè≥Ô∏è', reason: '16v10: surrender √≥ptimo', index: null };
      }
      if(myTotal === 15 && dealerValue === 10) {
        if(tc >= ILLUSTRIOUS_18['15v10']) {
          return { action: 'STAND', emoji: '‚úã', reason: `15v10 TC‚â•+${ILLUSTRIOUS_18['15v10']}: plantarse (Ill-18)`, index: ILLUSTRIOUS_18['15v10'] };
        }
        return { action: 'SURRENDER', emoji: 'üè≥Ô∏è', reason: '15v10: surrender', index: null };
      }
    }
    if(pair) {
      const card = playerHand[0];
      if(card === 'A' || card === '8') {
        return { action: 'SPLIT', emoji: '‚úÇÔ∏è', reason: 'Siempre divide Ases y 8s', index: null };
      }
      if(CARD_VALUES[card] === 10) {
        if(dealerValue === 5 && tc >= ILLUSTRIOUS_18['20v5']) {
          return { action: 'SPLIT', emoji: '‚úÇÔ∏è', reason: `20v5 TC‚â•+${ILLUSTRIOUS_18['20v5']}: divide (Ill-18)`, index: ILLUSTRIOUS_18['20v5'] };
        }
        if(dealerValue === 6 && tc >= ILLUSTRIOUS_18['20v6']) {
          return { action: 'SPLIT', emoji: '‚úÇÔ∏è', reason: `20v6 TC‚â•+${ILLUSTRIOUS_18['20v6']}: divide (Ill-18)`, index: ILLUSTRIOUS_18['20v6'] };
        }
        return { action: 'STAND', emoji: '‚úã', reason: '20 excelente, no dividir', index: null };
      }
    }
    if(soft) {
      if(myTotal >= 19) return { action: 'STAND', emoji: '‚úã', reason: 'Soft 19+ muy fuerte', index: null };
      if(myTotal === 18) {
        if(dealerValue >= 9) return { action: 'HIT', emoji: 'üëÜ', reason: 'Soft 18 vs 9/10/A: mejora', index: null };
        if(dealerValue >= 2 && dealerValue <= 6 && playerHand.length === 2) {
          return { action: 'DOUBLE', emoji: 'üí∞', reason: 'Soft 18 vs d√©bil: dobla', index: null };
        }
        return { action: 'STAND', emoji: '‚úã', reason: 'Soft 18 aceptable', index: null };
      }
      if(dealerValue >= 4 && dealerValue <= 6 && playerHand.length === 2) {
        return { action: 'DOUBLE', emoji: 'üí∞', reason: 'Soft vs d√©bil: dobla', index: null };
      }
      return { action: 'HIT', emoji: 'üëÜ', reason: 'Soft bajo: pide', index: null };
    }
    
    // Hard hands con Illustrious 18
    if(myTotal === 13) {
      if(dealerValue === 2 && tc >= ILLUSTRIOUS_18['13v2']) {
        return { action: 'STAND', emoji: '‚úã', reason: `13v2 TC‚â•${ILLUSTRIOUS_18['13v2']}: plantarse (Ill-18)`, index: ILLUSTRIOUS_18['13v2'] };
      }
      if(dealerValue === 3 && tc >= ILLUSTRIOUS_18['13v3']) {
        return { action: 'STAND', emoji: '‚úã', reason: `13v3 TC‚â•${ILLUSTRIOUS_18['13v3']}: plantarse (Ill-18)`, index: ILLUSTRIOUS_18['13v3'] };
      }
      if(dealerValue >= 2 && dealerValue <= 6) {
        return { action: 'STAND', emoji: '‚úã', reason: '13 vs d√©bil: dealer puede buscar', index: null };
      }
    }
    if(myTotal === 12) {
      if(dealerValue === 2 && tc >= ILLUSTRIOUS_18['12v2']) {
        return { action: 'STAND', emoji: '‚úã', reason: `12v2 TC‚â•+${ILLUSTRIOUS_18['12v2']}: plantarse (Ill-18)`, index: ILLUSTRIOUS_18['12v2'] };
      }
      if(dealerValue === 3 && tc >= ILLUSTRIOUS_18['12v3']) {
        return { action: 'STAND', emoji: '‚úã', reason: `12v3 TC‚â•+${ILLUSTRIOUS_18['12v3']}: plantarse (Ill-18)`, index: ILLUSTRIOUS_18['12v3'] };
      }
      if(dealerValue === 4 && tc >= ILLUSTRIOUS_18['12v4']) {
        return { action: 'STAND', emoji: '‚úã', reason: `12v4 TC‚â•${ILLUSTRIOUS_18['12v4']}: plantarse (Ill-18)`, index: ILLUSTRIOUS_18['12v4'] };
      }
      if(dealerValue >= 4 && dealerValue <= 6) {
        return { action: 'STAND', emoji: '‚úã', reason: '12 vs 4-6: dealer d√©bil', index: null };
      }
      return { action: 'HIT', emoji: 'üëÜ', reason: '12: pide', index: null };
    }
    if(myTotal === 11) {
      if(dealerCard === 'A' && tc >= ILLUSTRIOUS_18['11vA'] && playerHand.length === 2) {
        return { action: 'DOUBLE', emoji: 'üí∞', reason: `11vA TC‚â•+${ILLUSTRIOUS_18['11vA']}: dobla (Ill-18)`, index: ILLUSTRIOUS_18['11vA'] };
      }
      if(playerHand.length === 2 && dealerValue <= 10) {
        return { action: 'DOUBLE', emoji: 'üí∞', reason: '11 perfecto para doblar', index: null };
      }
      return { action: 'HIT', emoji: 'üëÜ', reason: '11: pide', index: null };
    }
    if(myTotal === 10 && playerHand.length === 2) {
      if(dealerValue === 10 && tc >= ILLUSTRIOUS_18['10v10']) {
        return { action: 'DOUBLE', emoji: 'üí∞', reason: `10v10 TC‚â•+${ILLUSTRIOUS_18['10v10']}: dobla (Ill-18)`, index: ILLUSTRIOUS_18['10v10'] };
      }
      if(dealerCard === 'A' && tc >= ILLUSTRIOUS_18['10vA']) {
        return { action: 'DOUBLE', emoji: 'üí∞', reason: `10vA TC‚â•+${ILLUSTRIOUS_18['10vA']}: dobla (Ill-18)`, index: ILLUSTRIOUS_18['10vA'] };
      }
      if(dealerValue >= 2 && dealerValue <= 9) {
        return { action: 'DOUBLE', emoji: 'üí∞', reason: '10 vs 2-9: dobla', index: null };
      }
    }
    if(myTotal === 9 && playerHand.length === 2) {
      if(dealerValue === 2 && tc >= ILLUSTRIOUS_18['9v2']) {
        return { action: 'DOUBLE', emoji: 'üí∞', reason: `9v2 TC‚â•+${ILLUSTRIOUS_18['9v2']}: dobla (Ill-18)`, index: ILLUSTRIOUS_18['9v2'] };
      }
      if(dealerValue === 7 && tc >= ILLUSTRIOUS_18['9v7']) {
        return { action: 'DOUBLE', emoji: 'üí∞', reason: `9v7 TC‚â•+${ILLUSTRIOUS_18['9v7']}: dobla (Ill-18)`, index: ILLUSTRIOUS_18['9v7'] };
      }
      if(dealerValue >= 3 && dealerValue <= 6) {
        return { action: 'DOUBLE', emoji: 'üí∞', reason: '9 vs 3-6: dobla', index: null };
      }
    }
    if(myTotal >= 17) return { action: 'STAND', emoji: '‚úã', reason: '17+ seguro', index: null };
    if(myTotal >= 13 && myTotal <= 16) {
      if(dealerValue >= 2 && dealerValue <= 6) {
        return { action: 'STAND', emoji: '‚úã', reason: 'Dealer d√©bil: puede buscar', index: null };
      }
      return { action: 'HIT', emoji: 'üëÜ', reason: 'Dealer fuerte: mejora', index: null };
    }
    return { action: 'HIT', emoji: 'üëÜ', reason: 'Total bajo: pide', index: null };
  }
  
  static handValue(hand) {
    if(!hand || !hand.length) return 0;
    let total = 0, aces = 0;
    hand.forEach(c => {
      if(c === 'A') { total += 11; aces++; }
      else total += CARD_VALUES[c];
    });
    while(total > 21 && aces > 0) { total -= 10; aces--; }
    return total;
  }
  
  static isSoft(hand) {
    if(!hand || !hand.length) return false;
    let total = 0, aces = 0;
    hand.forEach(c => {
      if(c === 'A') { total += 11; aces++; }
      else total += CARD_VALUES[c];
    });
    return aces > 0 && total <= 21;
  }
  
  static isPair(hand) {
    return hand.length === 2 && CARD_VALUES[hand[0]] === CARD_VALUES[hand[1]];
  }
}

class Humanizer {
  static shouldMakeError(tc, bet) {
    if(!CONFIG.enableHumanizer) return false;
    let errorProb = CONFIG.errorRate / 100;
    if(tc <= 0) errorProb *= 1.8;
    if(state.handsPlayed > 150) errorProb *= 1.3;
    if(bet > CONFIG.minBet * 6) errorProb *= 0.3;
    if(tc >= 4) errorProb = 0;
    return Math.random() < errorProb;
  }
  
  static introduceError(optimalAction) {
    const alternatives = {
      'HIT': ['STAND'],
      'STAND': ['HIT'],
      'DOUBLE': ['HIT'],
      'SPLIT': ['HIT']
    };
    const options = alternatives[optimalAction] || ['STAND'];
    return options[Math.floor(Math.random() * options.length)];
  }
}

function initializePlayers() {
  state.players = [];
  for(let i = 1; i <= CONFIG.numPlayers; i++) {
    state.players.push({
      id: i,
      cards: [],
      isYou: i === CONFIG.yourPosition
    });
  }
  renderPlayers();
}

function renderPlayers() {
  const area = document.getElementById('playersArea');
  area.innerHTML = '';
  state.players.forEach(player => {
    const div = document.createElement('div');
    div.className = 'player-box' + (player.isYou ? ' you' : '');
    div.id = `player${player.id}`;
    div.innerHTML = `
      <div class="player-title">
        <span>${player.isYou ? 'üë§ T√ö' : `Jugador ${player.id}`}</span>
        <span style="font-size:12px; opacity:0.7;">Pos. ${player.id}</span>
      </div>
      <div class="player-cards" id="player${player.id}Cards"></div>
      <div class="player-total" id="player${player.id}Total"></div>
    `;
    area.appendChild(div);
  });
}

function renderCardSelector() {
  const selector = document.getElementById('cardSelector');
  selector.innerHTML = '';
  ALL_CARDS.forEach(card => {
    const btn = document.createElement('button');
    btn.className = 'card-btn';
    btn.textContent = card;
    btn.onclick = () => registerCard(card);
    const val = HI_LO[card];
    if(val > 0) btn.classList.add('low');
    else if(val < 0) btn.classList.add('high');
    else btn.classList.add('mid');
    selector.appendChild(btn);
  });
}

function setRegisterMode(mode) {
  state.registerMode = mode;
  const texts = {
    myCard: 'üë§ Registrando: TUS CARTAS',
    tableCard: 'üë• Registrando: OTROS JUGADORES',
    dealerCard: 'üé¥ Registrando: DEALER VISIBLE'
  };
  document.getElementById('registerModeText').textContent = texts[mode];
  document.getElementById('phaseIndicator').textContent = texts[mode];
}

function registerCard(card) {
  if(!state.registerMode) {
    alert('‚ö†Ô∏è Primero selecciona un modo: MI CARTA, CARTA MESA o CARTA DEALER');
    return;
  }
  
  Counter.updateCount(card);
  
  if(state.registerMode === 'myCard') {
    state.myCards.push(card);
    const myPlayer = state.players.find(p => p.isYou);
    myPlayer.cards.push(card);
    logEntry(`üë§ Tu carta: ${card} | RC=${state.runningCount > 0 ? '+' : ''}${state.runningCount}`, 'success');
  } else if(state.registerMode === 'dealerCard') {
    state.dealer.cards.push(card);
    if(!state.dealer.visibleCard) state.dealer.visibleCard = card;
    logEntry(`üé¥ Dealer muestra: ${card} | RC=${state.runningCount > 0 ? '+' : ''}${state.runningCount}`, 'warning');
  } else {
    logEntry(`üë• Carta mesa: ${card} | RC=${state.runningCount > 0 ? '+' : ''}${state.runningCount}`, '');
  }
  
  if(navigator.vibrate) navigator.vibrate(10);
  updateUI();
  calculateDecision();
}

function calculateDecision() {
  if(state.myCards.length === 0 || !state.dealer.visibleCard) {
    document.getElementById('aiAction').textContent = '‚è≥ Datos incompletos';
    document.getElementById('aiReason').textContent = 'Registra tus cartas y la carta visible del dealer';
    return;
  }
  
  const tc = Counter.trueCount();
  const bet = BetManager.getSuggestedBet(tc);
  const strategy = Strategy.getOptimalPlay(state.myCards, state.dealer.visibleCard, tc);
  
  let finalAction = strategy.action;
  let isError = false;
  
  if(Humanizer.shouldMakeError(tc, bet)) {
    const original = strategy.action;
    finalAction = Humanizer.introduceError(original);
    isError = true;
    state.humanErrors++;
    const msg = `üé≠ CAMUFLAJE: Se recomienda "${finalAction}" en lugar de "${original}" para evitar detecci√≥n`;
    showHumanizerAlert(msg);
    logEntry(msg, 'warning');
    strategy.reason = `${strategy.reason} (‚ö†Ô∏è CAMUFLAJE ACTIVO)`;
  }
  
  document.getElementById('aiAction').textContent = strategy.emoji + ' ' + finalAction;
  document.getElementById('aiReason').textContent = strategy.reason;
  document.getElementById('aiDecision').textContent = finalAction;
  document.getElementById('aiIndex').textContent = strategy.index !== null ? strategy.index : '-';
  document.getElementById('aiConfidence').textContent = isError ? '‚ö†Ô∏è CAMUFLAJE' : '100%';
  
  logEntry(`üß† Decisi√≥n: ${finalAction} | ${strategy.reason}`, 'success');
}

function newHand() {
  state.myCards = [];
  state.dealer = { cards: [], visibleCard: null };
  state.players.forEach(p => p.cards = []);
  state.registerMode = null;
  state.handsPlayed++;
  
  document.getElementById('phaseIndicator').textContent = 'üÜï Nueva mano - Registra el reparto inicial';
  document.getElementById('aiAction').textContent = '‚è≥ Esperando cartas...';
  document.getElementById('aiReason').textContent = 'Registra las cartas del reparto';
  document.getElementById('registerModeText').textContent = 'Selecciona un modo arriba';
  
  logEntry(`üÜï NUEVA MANO #${state.handsPlayed}`, 'success');
  
  if(shoe.needsShuffle(CONFIG.penetration)) {
    logEntry('‚ö†Ô∏è SHUFFLE recomendado - penetraci√≥n alcanzada', 'warning');
  }
  
  updateUI();
}

function shuffle() {
  if(!confirm('¬øConfirmar SHUFFLE?')) return;
  state.runningCount = 0;
  state.cardsPlayed = 0;
  shoe.reset();
  logEntry('üîÑ SHUFFLE completado - Conteo reseteado', 'success');
  updateUI();
}

function resetAll() {
  if(!confirm('¬øRESET TOTAL? Borra todo el progreso')) return;
  state = {
    runningCount: 0,
    cardsPlayed: 0,
    currentBankroll: CONFIG.bankroll,
    handsPlayed: 0,
    handsWon: 0,
    handsLost: 0,
    handsPush: 0,
    humanErrors: 0,
    registerMode: null,
    currentPhase: 'waiting',
    players: [],
    dealer: { cards: [], visibleCard: null },
    myCards: [],
    gameLog: []
  };
  shoe.reset();
  initializePlayers();
  logEntry('üí£ RESET COMPLETO', 'success');
  updateUI();
}

function updateUI() {
  const tc = Counter.trueCount();
  const bet = BetManager.getSuggestedBet(tc);
  const edge = Counter.calculateEdge(tc);
  const penetration = Math.round((state.cardsPlayed / shoe.totalCards) * 100);
  
  const rcEl = document.getElementById('rc');
  rcEl.textContent = state.runningCount > 0 ? '+' + state.runningCount : state.runningCount;
  rcEl.className = 'stat
    
